<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Content Registration</title>
    <link rel="stylesheet" th:href="@{/css/noticeUpdate.css}">

    <!-- jQuery and jQuery UI -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

    <script>
        $(function() {
            // Custom Japanese localization for jQuery UI DatePicker
            $.datepicker.regional['ja'] = {
                closeText: '閉じる',
                prevText: '前',
                nextText: '次',
                currentText: '今日',
                monthNames: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                monthNamesShort: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                dayNames: ['日曜日', '月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日'],
                dayNamesShort: ['日', '月', '火', '水', '木', '金', '土'],
                dayNamesMin: ['日', '月', '火', '水', '木', '金', '土'],
                weekHeader: '週',
                dateFormat: 'yyyymmdd',
                firstDay: 0,
                isRTL: false,
                showMonthAfterYear: true,
                yearSuffix: '年'
            };

            $.datepicker.setDefaults($.datepicker.regional['ja']);

            // Initialize datepickers
            $("#beginYmd, #endYmd").datepicker({
                dateFormat: 'dd-mm-yy',
                changeYear: true,
                changeMonth: true,
                showButtonPanel: true,
                beforeShowDay: function (date) {
                    var day = date.getDay();
                    if (day === 0) {
                        return [true, "sunday-highlight"];
                    } else if (day === 6) {
                        return [true, "saturday-highlight"];
                    }
                    return [true, ""];
                }
            });
        });
    </script>



    <script type="text/javascript">
        $(document).ready(function() {
            // Fetch roles via AJAX
            $.get('/roles', function(roles) {
                roles.forEach(function(role) {
                    let checkbox = `<div class="checkbox-item">
                                        <input type="checkbox" name="roles" class="item-checkbox" value="${role.role}" checked />
                                        <label>[${role.role}] ${role.roleName}</label>
                                    </div>`;
                    $('.checkbox-list').append(checkbox);
                });
            });

            // Toggle all checkboxes on button click
            $('.all-btn').click(function() {
                let allChecked = $('.item-checkbox').length === $('.item-checkbox:checked').length;
                // If all are checked, uncheck them; otherwise, check them
                $('.item-checkbox').prop('checked', !allChecked);
            });
        });
    </script>

    <script>
        $(document).ready(function () {

                 // Custom validation for the form
        $('.register-btn').click(function(event) {
            event.preventDefault(); // Prevent form submission

            let errors = [];

             // Clear previous error styles
           $('#beginYmd, #endYmd, #title,#text').removeClass('error-border');
           $('.checkbox-list').removeClass('error-border');

            // Check if start date and title are entered
            let startYmd = $('#beginYmd').val().trim();
            let endedYmd = $('#endYmd').val().trim();
            let title = $('#title').val().trim();
            let rolesChecked = $('.item-checkbox:checked').length;
            let text = $('#text').val().trim();

            if (startYmd === '') {
                errors.push("[[#{startYmd_error}]]");
                $('#beginYmd').addClass('error-border');
            }
            if (title === '') {
                errors.push("[[#{title_error}]]");
                 $('#title').addClass('error-border');
            }
            if (rolesChecked === 0) {
                errors.push("[[#{role_error}]]");
                $('.checkbox-list').addClass('error-border');
            }

            // Function to calculate the byte length of a string
function getByteLength(str) {
    let byteLength = 0;
    for (let i = 0; i < str.length; i++) {
        let charCode = str.charCodeAt(i);
        if (charCode <= 0x007F) {
            byteLength += 1;  // ASCII character takes 1 byte
        } else if (charCode <= 0x07FF) {
            byteLength += 2;  // Non-ASCII characters take 2 bytes
        } else if (charCode <= 0xFFFF) {
            byteLength += 3;  // More complex characters take 3 bytes
        } else {
            byteLength += 4;  // Any others take 4 bytes
        }
    }
    return byteLength;
}

    // Check if the byte length exceeds 4000
    if (getByteLength(text) > 4000) {
        errors.push("[[#{content_error}]]");
        $('#text').addClass('error-border');
    }
           if (startYmd && endedYmd) {
    // Function to convert dd-mm-yyyy to yyyy-mm-dd
    function convertDateFormat(dateString) {
        const [day, month, year] = dateString.split("-");
        return `${year}-${month}-${day}`; // Converts to 'yyyy-mm-dd'
    }

    // Convert both date strings
    let formattedStartYmd = convertDateFormat(startYmd);
    let formattedEndedYmd = convertDateFormat(endedYmd);

    // Parse the converted dates
    let startDate = Date.parse(formattedStartYmd);
    let endDate = Date.parse(formattedEndedYmd);

    // Check if the dates are valid
    if (isNaN(startDate) || isNaN(endDate)) {
        errors.push('Invalid date format. Please use dd-mm-yyyy.');
    } else if (startDate > endDate) {
        errors.push("[[#{date_error}]]");
        $('#beginYmd, #endYmd').addClass('error-border');
    }
}
            // If there are errors, display them in the error div
            if (errors.length > 0) {
                let errorHtml = '<ul>';
                errors.forEach(function(error) {
                    errorHtml += '<li>' + error + '</li>';
                });
                errorHtml += '</ul>';

                $('#error-messages').html(errorHtml);
                $('#error-messages').show(); // Show the error div
                $('html, body').animate({
                    scrollTop: $("#error-messages").offset().top
                }, 500); // Scroll to the error div

            } else {
                // No errors, submit the form
                $('#contentForm').submit();


            }
        });
     });
    </script>

    <script type="text/javascript">
        function confirmLeave() {
            const confirmMessage = "Input contents are destroyed, all right?";

            if (confirm(confirmMessage)) {
                // User clicked "OK", allow the default behavior (navigate to /search)
                return true;
            } else {
                // User clicked "Cancel", prevent the navigation
                return false;
            }
        }
    </script>
    <script>
        function switchLanguage(lang) {
            const url = new URL(window.location.href);
            url.searchParams.set('lang', lang);
            window.location.href = url;
        }
    </script>







</head>
<body>
<div th:replace="~{fragments/Navbar :: Navbar}"></div>
<div class="breadcrumb-container">
    <div class="breadcrumb">
        <span><a href="/toppage" style="text-decoration:none" onclick="return confirmLeave()" th:text="#{top}">TOP</a></span>
        <span class="separator">&gt;</span>
        <span th:text="#{admin_menu}">Admin Menu</span>
        <span class="separator">&gt;</span>
        <span><a href="/search" style="text-decoration:none" onclick="return confirmLeave()" th:text="#{notice_list}">Notice List</a></span>
        <span class="separator">&gt;</span>
        <span th:text="#{notice_edit}">Notice Edit</span>
    </div>
    <div class="page-number">S17</div>
</div>
<div class="form-container">
    <!-- Error Div for displaying validation errors -->
    <div id="error-messages" class="error-container" style="display: none;"></div>

    <div class="header-buttons">
        <a th:href="@{/noticeDetail/{seqInfo}(seqInfo=${baseInfoUpdateDto.seqInfo})}" class="back-link" onclick="return confirmLeave()" th:text="#{back}">Back</a>
        <button type="submit" form="contentForm" class="register-btn" th:text="#{register}">register</button>
    </div>

    <form id="contentForm" th:action="@{/noticeUpdate/{seqInfo}(seqInfo=${baseInfoUpdateDto.seqInfo})}" method="post">
        <!-- Thymeleaf will set the action URL dynamically with the seqInfo value -->

        <!-- Spring hidden method field to support PUT -->
        <input type="hidden" name="_method" value="PUT" />
        <div class="section">
            <h2 th:text="#{display_condition}">Display Condition</h2>
<!--            <p th:text="${baseInfoUpdateDto.seqInfo}">as</p>-->
            <table class="condition-table">
                <tr>
                    <td class="label" th:text="#{display_period}">Display Period</td>
                    <td>
                        <input type="text" id="beginYmd" name="beginYmd" th:value="${#dates.format(baseInfoUpdateDto.beginYmd, 'dd-MM-yyyy')}" />
                        ~
                        <input type="text" id="endYmd" name="endYmd" th:value="${#dates.format(baseInfoUpdateDto.endYmd, 'dd-MM-yyyy')}" />
                    </td>
                    <td class="label" th:text="#{importance}">Importance</td>
                    <td>
                        <input type="checkbox" id="importantFlg" name="importantFlg" value="Y"
                               th:checked="${baseInfoUpdateDto.importantFlg == 'Y'}" />
                        <label for="importantFlg">Important</label>
                    </td>
                </tr>
                <tr>
                    <td class="label">
                        <span th:text="#{open_list}">Open List</span>
                        <button type="button" class="all-btn" th:text="#{all}">all</button>
                    </td>                    <td colspan="3">

                        <div class="checkbox-list">

                            <div class="checkbox-item">

                            </div>

                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="label">Create</td>
                    <td th:text="${#dates.format(baseInfoUpdateDto.crtTimestamp, 'yyyy/MM/dd HH:mm:ss')} + ' ' + ${baseInfoUpdateDto.crtUserId}">
                    <td class="label">Update</td>
                    <td th:text="${#dates.format(baseInfoUpdateDto.updTimestamp, 'yyyy/MM/dd HH:mm:ss')} + ' ' + ${baseInfoUpdateDto.updUserId}"></td>
                </tr>
            </table>
        </div>

        <div class="section">
            <h2 th:text="#{display_content}">Display Content</h2>
            <table class="content-table">
                <tr>
                    <td class="label" th:text="#{title}">Title</td>
                    <td>
                        <input type="text" id="title" name="title" class="full-width" th:value="${baseInfoUpdateDto.title}"/>
                    </td>
                </tr>
                <tr>
                    <td class="label" th:text="#{content}">Content</td>
                    <td>
                        <textarea id="text" name="text" class="full-width" th:text="${baseInfoUpdateDto.text}" rows="10" ></textarea>
                    </td>
                </tr>
                <tr>
                    <td class="label" th:text="#{attachment_file}">Attachment File</td>
                    <td>
                        <input type="file" id="attachment" />
                    </td>
                </tr>
            </table>
        </div>
    </form>

    <div class="footer-buttons">
        <a th:href="@{/noticeDetail/{seqInfo}(seqInfo=${baseInfoUpdateDto.seqInfo})}" class="back-link" onclick="return confirmLeave()" th:text="#{back}">Back</a>
        <button type="submit" form="contentForm" class="register-btn" th:text="#{register}">register</button>
    </div>
</div>
</body>
</html>